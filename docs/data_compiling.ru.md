# Описание сборки данных

Запуск сборки данных осущствляется командой:

```
Usage:
  data.js [OPTIONS] [ARGS]


Options:
  -h, --help : Help
  -env ENVIRONMENT, --environment=ENVIRONMENT : Environment for data compiling. May be "dev", "testing" or "production" (required)
  -v VERSION, --version=VERSION : Version of snapshots
```

Здесь `-env` - параметр, который указывает на окружение для которого будет осуществляться сборка данных.
По умолчанию `-env` принимает значение 'dev'. Также допустимыми значениями для этого параметра
являются 'testing' и 'production'.

`-v` - определяет, то какая версия собранных данных будет активной

Если данный параметр не указан, то сборка данных осуществляется полностью, и собранный snapshot
становится активным для данного окружения.

Если параметр `-v` указан, то сборка будет пропущена, а snapshot соответствующий значению, этого параметра
станет активным для данного окружения.

Для `dev` режима это означает, что файлы из папки `backups/snapshot_{dd:mm:yyyy-hh:mm:ss}` будут скопированы
в корень папки `backups`.

Для режимов `testing` и `production` файлы из папки соответствующего snapshot-а будут скопированы
в папки названия которых совпадают с выбранным окружением

```
{config model directory}/snapshot_{dd:mm:yyyy-hh:mm:ss}/* --> {config model directory}/{testing}
```
```
{config model directory}/snapshot_{dd:mm:yyyy-hh:mm:ss}/* --> {config model directory}/{production}
```

Значениями параметра -v могут быть:

* Полное название snapshot-а: 'snapshot_{dd:mm:yyyy-hh:mm:ss}'
* Количество собранных snapshot-ов между целевым snapshot-ом и последней версией собранных данных. Например,
чтобы откатиться на 3 версии собранных данных назад, необходимо запустить сборку данных с параметром `-v -3`. 
* 0 или 'latest' - установить активным последний собранный snapshot.
* -1 или 'previous' - установить активным предыдущий собранный snapshot.

## Этапы сборки данных

Сборка snapshot-а проходит в несколько четко выраженных этапов:

### Подключение модели данных

На этом этапе происхоходит подключение модуля `model/index.js` и соответственно всех подключенных к `model/index.js`
модулей. Такое подключение возвращает обхект, содержащий 'скелетную' информацию описывающую структуру сайта.

### Анализ модели данных

### Анализ и сбор мета-информации, загрузка `*.md` ресурсов
 
### Загрузка информации по авторам и переводчикам
 
### Генерация динамических узлов модели для авторов, переводчиков и тегов

### Загрузка данных по библиотекам блоков и генерация динамических узлов модели для библиотеков блоков.

### Переопределение ссылок
 
### Генерация файла sitemap.xml
 
### Сохранение и выгрузка данных
 
Сформированные данные сохраняются в виде 3-х файлов:
  
* `data.json` - собранная модель для работы сайта. Включает в себя дерево структуры сайта, инфоррмацию по тегам, авторам,
и библиотекам блоков, загруженные и распарсенные  `*.md` ресурсы, а также полную карту маршрутов для сайта.
  
* `marker.json` - файл, который содержит хэш-сумму от собранной структуры данных data.json, а также точную дату сборки.
Необходим для выполнения проверок того, что данные были изменены.

* `sitemap.xml` - файл для индексирования поисковыми системами.

В зависимости от установленного в параметре `-env` окружения, эти 3 файла сохраняются либо локально на
файловую систему в директорию `backups/{snapshot_dd:mm:yyyy-hh:mm:ss}` либо выгружаются
на Yandex Disk в директорию `{config model directory}/{snapshot_dd:mm:yyyy-hh:mm:ss}`, где
`config model directory` - это название директории на Yandex Disk установленное в конфигурации сайта.
