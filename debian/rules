#!/usr/bin/make -f

YENV ?= production
NPM ?= npm --registry=http://registry.npmjs.org
ENB := $(shell $(NPM) bin)/enb
BOWER := $(shell $(NPM) bin)/bower

WWW_DESTDIR := debian/yandex-bem-info-www/usr/lib/yandex/bem-info-www
STATIC_DESTDIR := debian/yandex-bem-info-www/var/lib/yandex/bem-info-static
TMP_PREFIX := $(CURDIR)/debian/tmp

%:
	dh $@ --with=environment --no-restart

override_dh_auto_test override_dh_usrlocal:

override_dh_auto_build:
	YENV=$(YENV) make

override_dh_auto_install:
	$(NPM) install --global --production --prefix=$(TMP_PREFIX)

override_dh_auto_clean:
	rm -rf node_modules \
		src/libs \
		freeze \
		.borschik

override_dh_install:
	dh_install
	dh_installlogrotate
	dh_nodeubic -n
	dh_clearvcs
	dh_strip
	
	find $(STATIC_DESTDIR) \
		-not \( -name "robots.txt" -o -name "humans.txt" \
			-o -name "*.css" \
			-o -name "*.js" -o -name "*.deps.js" \
			-o -name "*.gif" -o -name "*.png" -o -name "*.jp*g" \
			-o -name "*.swf" -o -name "*.ico" -o -name "*.svg" \
			-o -name "*.eot" -o -name "*.ttf" -o -name "*.otf" -o -name "*.woff" \) \
		-a -not -type d \
		-delete
	
	find $(STATIC_DESTDIR) \
		-type f \
		\( -name "*.node.js" -o -name "*.priv.js" -o -name "*.bemtree.js" -o -name "*.bemhtml.js" \) \
		-delete
