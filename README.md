bem-engine
========

Платформа для создания сайтов с документацией.

В настоящее время на базе данной платформы созданы и работают следующие сайты:

* [Bem-Info](http://bem.info)
* [Лего-Сайт](http://lego.yandex-team.ru)

Установка и сборка данных
------

### Клонируем репозиторий
```
$ git clone git://github.yandex-team.ru/bem/bem-engine.git
$ cd bem-engine
```

### Собираем в dev-режиме
```
$ make
$ make data_dev
```

### Собираем в test-режиме
```
$ YENV=test make
$ make data_test
```

### Собираем в production-режиме
```
$ YENV=production make
$ make data_prod
```

Запуск
------

```
$ npm start
```

Чтобы заработали поддомены необходимо добавить в `/etc/hosts` записи:

```
127.0.0.1    localhost
127.0.0.1    ru.localhost
127.0.0.1    en.localhost
```

### Принцип сборки данных и построения модели:

На сайт собираются данные трех типов:

* Документация (статьи, документация к инструментам, новости и.т.д)
* Библиотеки блоков
* Информация по людям (авторы, переводчики)

Для каждого из этих типов данных предусмотрен свой сценарий загрузки.

Структура сайта собирается путем подключения скриптов, которые находятся в папке `/model`. Все
`*.js` файлы, которые там находятся имеют логичную и консистентную компоновку. Их расположение отражает структуру сайта.
Данные крипты при включении друг в друга возвращают объект - модель сайта с включенной мета-информацией для узлов,
имеющих ресурсы, а также ссылки на `*.md` файлы документации.

При запуске `$ make data_{env}` выполняются следующие действия:

* Сборка модели сайта из подключенных файлов из папки `/model`.
в единую древовидную структуру (Здесь и далее будем называть ее `sitemap`).
* Сборка и построение роутов для фреймворка [Susanin](https://github.com/nodules/susanin).
* Дополнение узлов `sitemap` дополнительными аттрибутами, необходимыми для работы приложения, и которые
могут быть вычислены автоматически. (При этом приоритет отдается значениям выставленным пользователем)
* Сбор узлов, имеющих связанные ресурсы.
* Сбор узлов, имеющих привязку к библиотекам блоков.
* Загрузка информации по авторам, перводчикам из специального репозитория, описание которого находится в конфигурационном файле
* Загрузка информации по библиотекам блоков и достраивание исходного дерева `sitemap` узлами, описывающими
библиотеки, всерсии библиотеки, уровни переопределения блоков и сами блоки.
* Анализ мета-информации для узлов, имеющих связанные ресурсы
* Сборка уникальных ключей авторов, переводчиков и тегов
* Загрузка и парсинг `*.md` файлов через github API для узлов, имеющих связанные ресурсы.
* Динамическое добавление узлов соответствующих авторам, переводчикам и тегам.
* Сохранение модели сайта, документации, данных по людям и данных о библиотеках блоков в файл `data.json`.
* Вычисление хеш суммы от содержимого файла `data.json` записывается в файл `marker.json`,
изменение которого отслеживается запущенным приложением. (только для `test` и `production` окружения)

ПРИМЕЧАНИЕ: При запуске в dev - режиме происходит сохранение на локальную файловую систему.
При запуске в production - режиме происходит загрука собранных `*.json` файлов на Яндекс Диск.

При запуске сервера происходит считывание файла `data.json` с локальной файловой систем
или Яндекс Диска в зависимости от выставленого окружения.

### Схема загрузки данных

![Схема загрузки данных](docs/make_data.png?raw=true)

### Схема работы приложения

![Схема работы приложения](docs/application_initialization.png?raw=true)

Ответственные за разработку:

@bemer
@tavria
@tadatuta
@blond
@dmytry